<div class="messaging-widget">
  <!-- Loading State -->
  @if (isLoading) {
  <div class="widget-loading">
    <div class="animate-pulse space-y-3">
      <div class="h-4 bg-surface-variant rounded w-full"></div>
      <div class="h-4 bg-surface-variant rounded w-3/4"></div>
      <div class="h-4 bg-surface-variant rounded w-1/2"></div>
    </div>
  </div>
  }

  <!-- Messaging Content -->
  @if (!isLoading) {
  <div class="messaging-content">
    <!-- Total Unread Count Badge -->
    @if (totalUnreadCount() > 0) {
    <div class="unread-badge">
      <span class="unread-count">{{ totalUnreadCount() }}</span>
      <span class="unread-label">unread messages</span>
    </div>
    }
    <!-- Threads List -->
    <div class="threads-list">
      @for (thread of displayedThreads(); track thread.id) {
      <div class="thread-item" [class.unread]="thread.unreadCount > 0" (click)="onThreadClick(thread)">
        <!-- Thread Avatar -->
        <div class="thread-avatar">
          <div class="avatar-circle">
            {{ getInitials(thread.name) }}
          </div>
          @if (thread.isActive) {
          <div class="online-indicator"></div>
          }
        </div>
        <!-- Thread Content -->
        <div class="thread-content">
          <div class="thread-header">
            <h4 class="thread-name">{{ thread.name }}</h4>
            <span class="thread-time">{{ formatTimestamp(thread.timestamp) }}</span>
          </div>
          <p class="thread-message">{{ truncateMessage(thread.lastMessage) }}</p>
        </div>
        <!-- Thread Actions -->
        <div class="thread-actions">
          <!-- Unread Count -->
          @if (thread.unreadCount > 0) {
          <div class="unread-count-badge">
            {{ thread.unreadCount > 99 ? '99+' : thread.unreadCount }}
          </div>
          }
          <!-- Call Button -->
          <button (click)="onStartCall(thread, $event)" class="call-button" title="Start audio call">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
              </path>
            </svg>
          </button>
        </div>
      </div>
      }
    </div>
    <!-- Empty State -->
    @if (displayedThreads().length === 0) {
    <div class="widget-empty">
      <svg class="h-12 w-12 text-on-surface-variant mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
        </path>
      </svg>
      <p class="text-sm text-on-surface-variant">No recent conversations</p>
    </div>
    }
    <!-- View All Link -->
    @if (displayedThreads().length > 0) {
    <div class="view-all-link">
      <button (click)="onDrillThrough()" class="text-primary-600 hover:text-primary-700 font-medium text-sm">
        View All Messages
      </button>
    </div>
    }
  </div>
  }
</div>